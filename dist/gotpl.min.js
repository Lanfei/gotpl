!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):(global=global||self).gotpl=factory()}(this,function(){"use strict";var module,x,jsTokens=(function(module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=/((['"])(?:(?!\2|\\).|\\(?:\r\n|[\s\S]))*(\2)?|`(?:[^`\\$]|\\[\s\S]|\$(?!\{)|\$\{(?:[^{}]|\{[^}]*\}?)*\}?)*(`)?)|(\/\/.*)|(\/\*(?:[^*]|\*(?!\/))*(\*\/)?)|(\/(?!\*)(?:\[(?:(?![\]\\]).|\\.)*\]|(?![\/\]\\]).|\\.)+\/(?:(?!\s*(?:\b|[\u0080-\uFFFF$\\'"~({]|[+\-!](?!=)|\.?\d))|[gmiyus]{1,6}\b(?![\u0080-\uFFFF$\\]|\s*(?:[+\-*%&|^<>!=?({]|\/(?![\/*])))))|(0[xX][\da-fA-F]+|0[oO][0-7]+|0[bB][01]+|(?:\d*\.\d+|\d+\.?)(?:[eE][+-]?\d+)?)|((?!\d)(?:(?!\s)[$\w\u0080-\uFFFF]|\\u[\da-fA-F]{4}|\\u\{[\da-fA-F]+\})+)|(--|\+\+|&&|\|\||=>|\.{3}|(?:[+\-\/%&|^]|\*{1,2}|<{1,2}|>{1,3}|!=?|={1,2})=?|[?~.,:;[\](){}])|(\s+)|(^$|[\s\S])/g,exports.matchToToken=function(match){var token={type:"invalid",value:match[0],closed:void 0};return match[1]?(token.type="string",token.closed=!(!match[3]&&!match[4])):match[5]?token.type="comment":match[6]?(token.type="comment",token.closed=!!match[7]):match[8]?token.type="regex":match[9]?token.type="number":match[10]?token.type="name":match[11]?token.type="punctuator":match[12]&&(token.type="whitespace"),token}}(module={exports:{}},module.exports),module.exports),jsTokens$1=(x=jsTokens)&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x,jsTokens_1=jsTokens.matchToToken,reservedKeywords={abstract:!0,await:!0,boolean:!0,break:!0,byte:!0,case:!0,catch:!0,char:!0,class:!0,const:!0,continue:!0,debugger:!0,default:!0,delete:!0,do:!0,double:!0,else:!0,enum:!0,export:!0,extends:!0,false:!0,final:!0,finally:!0,float:!0,for:!0,function:!0,goto:!0,if:!0,implements:!0,import:!0,in:!0,instanceof:!0,int:!0,interface:!0,let:!0,long:!0,native:!0,new:!0,null:!0,package:!0,private:!0,protected:!0,public:!0,return:!0,short:!0,static:!0,super:!0,switch:!0,synchronized:!0,this:!0,throw:!0,transient:!0,true:!0,try:!0,typeof:!0,var:!0,void:!0,volatile:!0,while:!0,with:!0,yield:!0},isKeywordJs=function(str){return reservedKeywords.hasOwnProperty(str)},matchHtmlRegExp=/["'&<>]/,escapeHtml_1=function(string){var escape,str=""+string,match=matchHtmlRegExp.exec(str);if(!match)return str;var html="",index=0,lastIndex=0;for(index=match.index;index<str.length;index++){switch(str.charCodeAt(index)){case 34:escape="&quot;";break;case 38:escape="&amp;";break;case 39:escape="&#39;";break;case 60:escape="&lt;";break;case 62:escape="&gt;";break;default:continue}lastIndex!==index&&(html+=str.substring(lastIndex,index)),lastIndex=index+1,html+=escape}return lastIndex!==index?html+str.substring(lastIndex,index):html};var LINE_RE=/\r?\n/g,INDENT_RE=/[\r\n]+([\f\t\v]*)/g,tplCache={},fileCache={},defOpts={root:"",debug:!1,cache:!0,minify:!0,openTag:"<%",closeTag:"%>"};function merge(target,objects){var arguments$1=arguments;target=target||{};for(var loop=function(i,l){var object=arguments$1[i];object&&Object.keys(object).forEach(function(key){target[key]=object[key]})},i=1,l=arguments.length;i<l;++i)loop(i);return target}function renderByPath(path,template,data,options){var filename=function(filename,base){var path=require("path");return path.isAbsolute(filename)||(base=base?path.resolve(base):defOpts.root,path.extname(base)&&(base=path.dirname(base)),filename=path.join(base,filename)),path.extname(filename)||(filename+=".tpl"),filename}(path,(options=merge({},defOpts,options)).filename||options.root),compiled=fileCache[filename];compiled||(options.filename=filename,compiled=compile(template=template||require("fs").readFileSync(filename).toString(),data,options),options.cache&&!options.debug&&(fileCache[filename]=compiled));try{return compiled(data)}catch(e){throw fileCache[filename]=null,e}}function renderFileSync(path,data,options){return renderByPath(path,null,data,options)}function compile(template,data,options){data=merge({},data),options=merge({},defOpts,options);var lines=1,variables=[],debug=options.debug,minify=options.minify,openTag=options.openTag,closeTag=options.closeTag,globalObj="undefined"!=typeof global?global:self,codes="var $$res = '';\n";return debug&&(codes="var $$line;\n"+codes+"try{\n$$line = 1;\t"),template.split(closeTag).forEach(function(segment){var logicCode,split=segment.split(openTag),html=split[0],logic=split[1];if(html){var htmlCode=function(codes){return"$$res += "+JSON.stringify(codes)}(html);htmlCode=minify?htmlCode.replace(INDENT_RE,"\\n"):htmlCode.replace(INDENT_RE,"\\n$1"),codes+=htmlCode+";\n",debug&&(lines+=html.split(LINE_RE).length-1,codes+="$$line = "+lines+";\t")}logic&&(logicCode=0===logic.indexOf("=")?parseValue(logic.slice(1),!0):0===logic.indexOf("-")?parseValue(logic.slice(1)):logic.trim(),codes+=logicCode+"\n",logicCode.match(jsTokens$1).map(function(keyword){return jsTokens$1.lastIndex=0,jsTokens_1(jsTokens$1.exec(keyword))}).forEach(function(token){var type=token.type,value=token.value;"name"===type&&!isKeywordJs(value)&&variables.indexOf(value)<0&&"$$"!==value.slice(0,2)&&"include"!==value&&variables.push(value)}),debug&&(lines+=logic.split(LINE_RE).length-1,codes+="$$line = "+lines+";\t"))}),codes+="return $$res;\n",codes=function(variables){var codes="$$data = $$data || {};\n";return variables.forEach(function(variable){codes+="var "+variable+" = $$data['"+variable+"'] === undefined ? $$global['"+variable+"'] : $$data['"+variable+"'];\n"}),codes}(variables)+codes,debug&&(codes+="}catch(e){\n$$rethrow(e, $$template, $$line);\n}\n"),codes="return function($$data){\n'use strict';\n"+codes+"}",new Function("$$global","$$template, $$escape, $$rethrow, include",codes)(globalObj,template,escapeHtml_1,rethrow,function(path,subData,subOptions){return renderFileSync(path,subData=merge({},data,subData),subOptions=merge({},options,subOptions))})}function parseValue(codes,escape){return escape?"$$res += $$escape("+codes.trim()+")":"$$res += ("+codes+")"}function rethrow(err,template,line){var lines=template.split(LINE_RE),start=Math.max(line-3,0),end=Math.min(lines.length,line+3);throw err.message+="\n\n"+lines.slice(start,end).map(function(codes,i){var curLine=start+i+1;return(curLine===line?" >> ":"    ")+curLine+"| "+codes}).join("\n")+"\n",err}return{config:function(options){merge(defOpts,options)},compile:compile,render:function(template,data,options){var compiled=tplCache[template];compiled||(compiled=compile(template,data,options=merge({},defOpts,options)),options.cache&&!options.debug&&(tplCache[template]=compiled));try{return compiled(data)}catch(e){throw tplCache[template]=null,e}},renderFile:function(path,data,options,next){var promise,fs=require("fs");return"function"==typeof data?(next=data,data=options=null):"function"==typeof options&&(next=options,options=null),next||(promise=new Promise(function(resolve,reject){next=function(err,data){err?reject(err):resolve(data)}})),fs.readFile(path,function(err,buffer){if(err)next(err);else try{next(null,renderByPath(path,buffer.toString(),data,options))}catch(err){next(err)}}),promise},renderFileSync:renderFileSync,escapeHTML:escapeHtml_1,version:"8.0.2"}});